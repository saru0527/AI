var SuggestResolutionHelperAjax = Class.create();

SuggestResolutionHelperAjax.prototype =
Object.extendsObject(AbstractAjaxProcessor, {

    getSuggestions: function() {

        var sysId =
this.getParameter('sysparm_sys_id');

        var query =
this.getParameter('sysparm_query');



        gs.info("üì§ [SuggestResolution] Sending request to FastAPI | sys_id: " + sysId +
", query: " + query);



        var payload =
JSON.stringify({

            "ticket_sys_id": sysId,

            "query": query

        });



        var r =
new sn_ws.RESTMessageV2();

        r.setEndpoint("https://d8ea8fe9fb3a.ngrok-free.app/suggest_resolution");  // üîÅ Your FastAPI endpoint

        r.setHttpMethod("POST");

        r.setRequestHeader("Content-Type",
"application/json");

        r.setRequestBody(payload);



        try {

            var response = r.execute();

            var responseBody = response.getBody();

            var parsed =
JSON.parse(responseBody);

            var summary = parsed.summary ||
"‚ùå No resolution suggestion found.";



            // ‚è∫Ô∏è Append to work_notes

            var gr =
new GlideRecord("incident");

            if (gr.get(sysId)) {

                gr.work_notes = "üí° AI Suggestion:\n" + summary;

                gr.update();

                gs.info("üìù work_notes updated for incident: " + sysId);

            } else {

                gs.warn("‚ö†Ô∏è Incident not found for sys_id: " + sysId);

            }



            return summary;



        } catch (ex) {

            gs.error("üî• FastAPI call failed: " + ex.message);

            return
"‚ùå Error: " + ex.message;

        }

    }

});